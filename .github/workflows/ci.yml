name: ci

on:
  push:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: |
          cd backend
          npm ci || npm install
          npm run lint
          npm test

  ml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: |
          cd ml-service
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m py_compile app.py

  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: |
          cd infrastructure/terraform
          terraform fmt -recursive -check
          terraform init -backend=false
          terraform validate

  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install conftest
        run: |
          sudo wget -qO /usr/local/bin/conftest https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz || true
      - name: Policy-as-code (starter)
        run: |
          echo "Policy stage placeholder (add OPA/Rego checks here)."
